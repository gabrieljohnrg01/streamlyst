<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamLyst - Your Ultimate Streaming Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a237e',
                        secondary: '#000000',
                        accent: '#1976d2'
                    }
                }
            }
        }
    </script>
    <style>
        .backdrop-blur {
            backdrop-filter: blur(10px);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .top-number {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 3rem;
            font-weight: bold;
            color: rgba(255,255,255,0.2);
            line-height: 1;
            z-index: 1;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-secondary text-white min-h-screen">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 z-50 hidden items-center justify-center backdrop-blur">
        <div class="bg-primary rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="authModalTitle">Login</h2>
                <button id="closeAuthModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="authForms">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block mb-1">Email</label>
                        <input type="email" id="loginEmail" required 
                            class="w-full px-3 py-2 bg-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label for="loginPassword" class="block mb-1">Password</label>
                        <input type="password" id="loginPassword" required 
                            class="w-full px-3 py-2 bg-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <button type="submit" class="w-full bg-accent py-2 rounded hover:bg-blue-700 transition">
                        Login
                    </button>
                </form>
                <form id="registerForm" class="space-y-4 hidden">
                    <div>
                        <label for="registerEmail" class="block mb-1">Email</label>
                        <input type="email" id="registerEmail" required 
                            class="w-full px-3 py-2 bg-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label for="registerUsername" class="block mb-1">Username</label>
                        <input type="text" id="registerUsername" required 
                            class="w-full px-3 py-2 bg-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label for="registerPassword" class="block mb-1">Password</label>
                        <input type="password" id="registerPassword" required 
                            class="w-full px-3 py-2 bg-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <button type="submit" class="w-full bg-accent py-2 rounded hover:bg-blue-700 transition">
                        Register
                    </button>
                </form>
                <p class="text-center mt-4">
                    <span id="showRegister" class="text-accent cursor-pointer hover:underline">Create an account</span>
                    <span id="showLogin" class="text-accent cursor-pointer hover:underline hidden">Already have an account? Login</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="playerModal" class="fixed inset-0 z-50 hidden items-center justify-center backdrop-blur p-4">
        <div class="bg-secondary rounded-lg w-full max-w-6xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="playerTitle" class="text-xl font-bold"></h2>
                <button id="closePlayerModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 relative">
                <iframe id="playerFrame" class="w-full h-full" 
                    frameborder="0" allowfullscreen 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>
            </div>
            <div id="playerInfo" class="p-4 border-t border-gray-700">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 id="currentEpisodeTitle" class="font-semibold"></h3>
                        <p id="currentEpisodeDescription" class="text-gray-400 text-sm"></p>
                    </div>
                    <div id="episodeControls" class="flex space-x-2">
                        <button id="prevEpisode" class="bg-primary px-3 py-1 rounded hover:bg-blue-800">
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                        <button id="nextEpisode" class="bg-primary px-3 py-1 rounded hover:bg-blue-800">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden items-center justify-center backdrop-blur p-4 overflow-y-auto">
        <div class="bg-secondary rounded-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <button id="closeDetailsModal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div class="relative">
                <div class="h-96 w-full bg-gradient-to-r from-primary to-secondary relative">
                    <img id="detailsBackdrop" src="https://placehold.co/1280x720" alt="Movie or show backdrop" 
                        class="w-full h-full object-cover opacity-40" />
                    <div class="absolute inset-0 flex items-end p-8 backdrop-blur-sm">
                        <div class="flex space-x-6">
                            <img id="detailsPoster" src="https://placehold.co/300x450" alt="Movie or show poster" 
                                class="w-48 h-64 object-cover rounded shadow-lg" />
                            <div>
                                <h1 id="detailsTitle" class="text-3xl font-bold mb-2"></h1>
                                <div id="detailsGenres" class="flex flex-wrap gap-2 mb-4"></div>
                                <p id="detailsOverview" class="text-gray-300 mb-4"></p>
                                <div class="flex items-center space-x-6">
                                    <div>
                                        <span class="text-gray-400">Status</span>
                                        <p id="detailsStatus" class="font-medium"></p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Released</span>
                                        <p id="detailsDate" class="font-medium"></p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Rating</span>
                                        <p id="detailsRating" class="font-medium"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-8">
                    <div class="flex space-x-4 mb-6">
                        <button id="watchNowBtn" class="bg-accent px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                            <i class="fas fa-play mr-2"></i> Watch Now
                        </button>
                        <button id="watchlistBtn" class="border border-accent px-6 py-2 rounded-lg hover:bg-blue-900 flex items-center">
                            <i class="fas fa-plus mr-2"></i> Add to Watchlist
                        </button>
                    </div>
                    <div id="seasonsContainer" class="mb-8">
                        <h2 class="text-xl font-bold mb-4">Seasons</h2>
                        <div id="seasonsList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                    <div id="episodesContainer" class="mb-8">
                        <h2 class="text-xl font-bold mb-4">Episodes</h2>
                        <div id="episodesList" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <header class="bg-primary/90 backdrop-blur fixed top-0 w-full z-40">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-8">
                <a href="#" class="text-2xl font-bold hover:text-accent transition">
                    <span class="text-accent">Stream</span>Lyst
                </a>
                <div class="hidden md:flex space-x-6">
                    <a href="#" class="hover:text-accent transition" data-section="home">Home</a>
                    <a href="#" class="hover:text-accent transition" data-section="movies">Movies</a>
                    <a href="#" class="hover:text-accent transition" data-section="tv">TV Shows</a>
                    <a href="#" class="hover:text-accent transition" data-section="anime">Anime</a>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="Search..." 
                        class="bg-gray-800 px-4 py-2 rounded-full focus:outline-none focus:ring-2 focus:ring-accent w-40 md:w-64">
                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                </div>
                <div id="authButtons" class="hidden md:block">
                    <button id="loginBtn" class="bg-accent px-4 py-2 rounded hover:bg-blue-700 transition">
                        Login / Register
                    </button>
                </div>
                <div id="userMenu" class="hidden items-center space-x-2">
                    <div class="relative">
                        <button id="menuToggle" class="flex items-center space-x-2">
                            <img id="userAvatar" src="https://placehold.co/40x40" alt="User profile picture" 
                                class="w-8 h-8 rounded-full object-cover" />
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="dropdownMenu" 
                            class="hidden absolute right-0 mt-2 w-48 bg-primary rounded-md shadow-lg py-1 z-50 border border-gray-700">
                            <a href="#" class="block px-4 py-2 hover:bg-accent hover:text-white transition" 
                                data-section="watchlist">My Watchlist</a>
                            <a href="#" class="block px-4 py-2 hover:bg-accent hover:text-white transition"
                                data-section="profile">Profile</a>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 hover:bg-accent hover:text-white transition">
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
                <button id="mobileMenuBtn" class="md:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-secondary z-30 hidden pt-20 px-4">
        <div class="space-y-4">
            <a href="#" class="block py-2 border-b border-gray-700" data-section="home">Home</a>
            <a href="#" class="block py-2 border-b border-gray-700" data-section="movies">Movies</a>
            <a href="#" class="block py-2 border-b border-gray-700" data-section="tv">TV Shows</a>
            <a href="#" class="block py-2 border-b border-gray-700" data-section="anime">Anime</a>
            <div id="mobileAuthButtons" class="pt-4">
                <button id="mobileLoginBtn" class="bg-accent w-full py-2 rounded hover:bg-blue-700 transition">
                    Login / Register
                </button>
            </div>
            <div id="mobileUserMenu" class="hidden">
                <a href="#" class="block py-2 border-b border-gray-700" data-section="watchlist">My Watchlist</a>
                <a href="#" class="block py-2 border-b border-gray-700" data-section="profile">Profile</a>
                <a href="#" id="mobileLogoutBtn" class="block py-2 text-red-400">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-20 pb-16">
        <div id="contentContainer" class="container mx-auto px-4">
            <!-- Home Section -->
            <section id="home" class="section fade-in">
                <div class="mb-8">
                    <div class="h-[70vh] relative rounded-xl overflow-hidden">
                        <img id="heroImage" src="https://placehold.co/1920x1080" alt="Popular movie or TV show on StreamLyst"
                            class="w-full h-full object-cover" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent flex items-end p-8">
                            <div class="max-w-3xl">
                                <h1 id="heroTitle" class="text-4xl md:text-5xl font-bold mb-4">Title</h1>
                                <p id="heroDescription" class="text-lg mb-6 text-gray-300">Description</p>
                                <div class="flex space-x-4">
                                    <button class="bg-accent px-6 py-3 rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-play mr-2"></i> Watch Now
                                    </button>
                                    <button class="border border-accent px-6 py-3 rounded-lg hover:bg-blue-900">
                                        <i class="fas fa-plus mr-2"></i> Watchlist
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="featuredSections" class="space-y-16">
                    <div>
                        <h2 class="text-2xl font-bold mb-6 flex items-center">
                            <i class="fas fa-fire text-accent mr-3"></i> Trending Movies
                        </h2>
                        <div id="trendingMovies" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-6 flex items-center">
                            <i class="fas fa-tv text-accent mr-3"></i> Popular TV Shows
                        </h2>
                        <div id="popularTv" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-6 flex items-center">
                            <i class="fas fa-dragon text-accent mr-3"></i> Trending Anime
                        </h2>
                        <div id="trendingAnime" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                </div>
            </section>

            <!-- Movies Section -->
            <section id="movies" class="section hidden">
                <h1 class="text-3xl font-bold mb-8">Top Movies</h1>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    <!-- Movies will be loaded here -->
                </div>
            </section>

            <!-- TV Shows Section -->
            <section id="tv" class="section hidden">
                <h1 class="text-3xl font-bold mb-8">Top TV Shows</h1>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    <!-- TV Shows will be loaded here -->
                </div>
            </section>

            <!-- Anime Section -->
            <section id="anime" class="section hidden">
                <h1 class="text-3xl font-bold mb-8">Top Anime</h1>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    <!-- Anime will be loaded here -->
                </div>
            </section>

            <!-- Watchlist Section -->
            <section id="watchlist" class="section hidden">
                <h1 class="text-3xl font-bold mb-8">My Watchlist</h1>
                <div id="watchlistContent" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-bookmark text-5xl mb-2"></i>
                        <p>Your watchlist is empty</p>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Profile</h1>
                <div class="bg-primary/20 rounded-xl p-6 max-w-3xl">
                    <div class="flex items-start space-x-6">
                        <img id="profileAvatar" src="https://placehold.co/120x120" 
                            alt="User profile picture" 
                            class="w-24 h-24 rounded-full border-2 border-accent object-cover" />
                        <div class="flex-1">
                            <h2 id="profileUsername" class="text-2xl font-bold mb-2"></h2>
                            <p id="profileEmail" class="text-gray-400 mb-4"></p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-400">Watchlist Items</span>
                                    <p id="watchlistCount" class="text-xl">0</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Account Created</span>
                                    <p id="accountCreated" class="text-xl"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Search Results Section -->
            <section id="searchResults" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Search Results</h1>
                <div id="searchResultsContent" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-primary/90 text-gray-300 py-8 backdrop-blur">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold text-white mb-4">StreamLyst</h3>
                    <p class="mb-4">Your ultimate streaming companion for movies, TV shows, and anime.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="hover:text-accent transition"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="hover:text-accent transition"><i class="fab fa-discord"></i></a>
                        <a href="#" class="hover:text-accent transition"><i class="fab fa-github"></i></a>
                    </div>
                </div>
                <div>
                    <h4 class="text-white mb-4 font-semibold">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="#" data-section="home" class="hover:text-accent transition">Home</a></li>
                        <li><a href="#" data-section="movies" class="hover:text-accent transition">Movies</a></li>
                        <li><a href="#" data-section="tv" class="hover:text-accent transition">TV Shows</a></li>
                        <li><a href="#" data-section="anime" class="hover:text-accent transition">Anime</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white mb-4 font-semibold">Legal</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="hover:text-accent transition">Terms of Service</a></li>
                        <li><a href="#" class="hover:text-accent transition">Privacy Policy</a></li>
                        <li><a href="#" class="hover:text-accent transition">DMCA</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-sm text-center">
                <p>© 2023 StreamLyst. All rights reserved.</p>
                <p class="mt-2">Powered by TMDB, AniList, and VidSrc.</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabase Configuration (replace with your actual credentials)
        const supabaseUrl = 'https://fxjfjuuewhecnyvpdwtc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4amZqdXVld2hlY255dnBkd3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwODc4NjAsImV4cCI6MjA2NjY2Mzg2MH0.Znwtrg4_srPFF6DV8beEE1Mvvi5RoyUzqYr1QaCnghQ';
        
        // Initialize Supabase
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // TMDB API Key
        const tmdbApiKey = 'fc5229ddcee9e96a1be1b8f8535063a3';
        
        // AniList GraphQL endpoint
        const anilistEndpoint = 'https://graphql.anilist.co';
        
        // Current User
        let currentUser = null;
        let currentMediaType = '';
        let currentMediaId = '';
        let currentSeason = 1;
        let seasonsData = [];
        let currentEpisodes = [];
        let currentAnimeData = null;
        
        // DOM Elements
        const authModal = document.getElementById('authModal');
        const authForms = document.getElementById('authForms');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginBtn = document.getElementById('loginBtn');
        const mobileLoginBtn = document.getElementById('mobileLoginBtn');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const userMenu = document.getElementById('userMenu');
        const mobileUserMenu = document.getElementById('mobileUserMenu');
        const logoutBtn = document.getElementById('logoutBtn');
        const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
        const authButtons = document.getElementById('authButtons');
        const mobileAuthButtons = document.getElementById('mobileAuthButtons');
        const userAvatar = document.getElementById('userAvatar');
        const menuToggle = document.getElementById('menuToggle');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        
        const playerModal = document.getElementById('playerModal');
        const playerFrame = document.getElementById('playerFrame');
        const currentEpisodeTitle = document.getElementById('currentEpisodeTitle');
        const currentEpisodeDescription = document.getElementById('currentEpisodeDescription');
        const prevEpisode = document.getElementById('prevEpisode');
        const nextEpisode = document.getElementById('nextEpisode');
        const closePlayerModal = document.getElementById('closePlayerModal');
        const playerTitle = document.getElementById('playerTitle');
        
        const detailsModal = document.getElementById('detailsModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsBackdrop = document.getElementById('detailsBackdrop');
        const detailsPoster = document.getElementById('detailsPoster');
        const detailsGenres = document.getElementById('detailsGenres');
        const detailsOverview = document.getElementById('detailsOverview');
        const detailsStatus = document.getElementById('detailsStatus');
        const detailsDate = document.getElementById('detailsDate');
        const detailsRating = document.getElementById('detailsRating');
        const watchNowBtn = document.getElementById('watchNowBtn');
        const watchlistBtn = document.getElementById('watchlistBtn');
        const seasonsContainer = document.getElementById('seasonsContainer');
        const seasonsList = document.getElementById('seasonsList');
        const episodesContainer = document.getElementById('episodesContainer');
        const episodesList = document.getElementById('episodesList');
        
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('[data-section]');
        
        const searchInput = document.getElementById('searchInput');
        const searchResultsContent = document.getElementById('searchResultsContent');
        
        const heroTitle = document.getElementById('heroTitle');
        const heroDescription = document.getElementById('heroDescription');
        const heroImage = document.getElementById('heroImage');
        
        const featuredSections = document.getElementById('featuredSections');
        const trendingMovies = document.getElementById('trendingMovies');
        const popularTv = document.getElementById('popularTv');
        const trendingAnime = document.getElementById('trendingAnime');
        
        const watchlistContent = document.getElementById('watchlistContent');
        
        const profileUsername = document.getElementById('profileUsername');
        const profileEmail = document.getElementById('profileEmail');
        const profileAvatar = document.getElementById('profileAvatar');
        const watchlistCount = document.getElementById('watchlistCount');
        const accountCreated = document.getElementById('accountCreated');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuthState();
            await loadFeaturedContent();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Auth modal
            loginBtn.addEventListener('click', () => authModal.classList.remove('hidden'));
            mobileLoginBtn.addEventListener('click', () => authModal.classList.remove('hidden'));
            closeAuthModal.addEventListener('click', () => authModal.classList.add('hidden'));
            
            // Toggle between login and register forms
            showRegister.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                document.getElementById('authModalTitle').textContent = 'Register';
                showRegister.classList.add('hidden');
                showLogin.classList.remove('hidden');
            });
            
            showLogin.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                document.getElementById('authModalTitle').textContent = 'Login';
                showLogin.classList.add('hidden');
                showRegister.classList.remove('hidden');
            });
            
            // Login form submit
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    currentUser = data.user;
                    updateAuthUI();
                    authModal.classList.add('hidden');
                } catch (error) {
                    alert(error.message);
                }
            });
            
            // Register form submit
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                
                try {
                    // Register user
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                username
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    // Create user profile
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .upsert({
                            id: data.user.id,
                            username,
                            email,
                            avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=1a237e&color=fff`
                        });
                    
                    if (profileError) throw profileError;
                    
                    alert('Registration successful! Please check your email to confirm your account.');
                    showLogin.click();
                } catch (error) {
                    alert(error.message);
                }
            });
            
            // Logout
            logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                currentUser = null;
                updateAuthUI();
                navigateToSection('home');
            });
            
            mobileLogoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                currentUser = null;
                updateAuthUI();
                navigateToSection('home');
            });
            
            // User menu toggle
            menuToggle.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });
            
            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#menuToggle')) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    navigateToSection(section);
                    mobileMenu.classList.add('hidden');
                });
            });
            
            // Player modal
            closePlayerModal.addEventListener('click', () => {
                playerModal.classList.add('hidden');
                playerFrame.src = '';
            });
            
            // Details modal
            closeDetailsModal.addEventListener('click', () => {
                detailsModal.classList.add('hidden');
            });
            
            // Search
            searchInput.addEventListener('keyup', async (e) => {
                if (e.key === 'Enter' && searchInput.value.trim()) {
                    await searchContent(searchInput.value.trim());
                    navigateToSection('searchResults');
                }
            });
            
            // Previous/Next episode buttons
            prevEpisode.addEventListener('click', () => {
                const currentEpisodeIndex = parseInt(playerFrame.getAttribute('data-episode-index'));
                if (currentEpisodeIndex > 0) {
                    playEpisode(currentEpisodeIndex - 1);
                }
            });
            
            nextEpisode.addEventListener('click', () => {
                const currentEpisodeIndex = parseInt(playerFrame.getAttribute('data-episode-index'));
                if (currentEpisodeIndex < currentEpisodes.length - 1) {
                    playEpisode(currentEpisodeIndex + 1);
                }
            });

            // Watchlist button
            watchlistBtn.addEventListener('click', () => {
                toggleWatchlist(currentMediaId, currentMediaType);
            });
        }
        
        async function checkAuthState() {
            const { data, error } = await supabase.auth.getUser();
            
            if (data.user) {
                currentUser = data.user;
                
                // Get additional user profile data
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!profileError && profile) {
                    currentUser.profile = profile;
                }
            }
            
            updateAuthUI();
        }
        
        function updateAuthUI() {
            if (currentUser) {
                authButtons.classList.add('hidden');
                mobileAuthButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                mobileUserMenu.classList.remove('hidden');
                
                // Set user avatar
                if (currentUser.profile?.avatar_url) {
                    userAvatar.src = currentUser.profile.avatar_url;
                    userAvatar.alt = `${currentUser.profile.username}'s avatar`;
                }
                
                // Load watchlist count
                updateWatchlistCount();
            } else {
                authButtons.classList.remove('hidden');
                mobileAuthButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
                mobileUserMenu.classList.add('hidden');
            }
        }

        async function updateWatchlistCount() {
            if (!currentUser) return;

            const { count, error } = await supabase
                .from('watchlist')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id);

            if (!error) {
                watchlistCount.textContent = count;
            }
        }

        function navigateToSection(sectionId) {
            // Hide all sections
            sections.forEach(section => {
                section.classList.add('hidden');
            });

            // Show the requested section
            document.getElementById(sectionId).classList.remove('hidden');

            // Load content for the section if empty
            if (sectionId === 'movies' && document.getElementById('movies').children.length === 1) {
                loadTopMovies();
            } else if (sectionId === 'tv' && document.getElementById('tv').children.length === 1) {
                loadTopTVShows();
            } else if (sectionId === 'anime' && document.getElementById('anime').children.length === 1) {
                loadTopAnime();
            } else if (sectionId === 'watchlist' && currentUser) {
                loadWatchlist();
            } else if (sectionId === 'profile' && currentUser) {
                loadProfile();
            }
        }

        async function loadFeaturedContent() {
            try {
                // Load trending movies
                const trendingMoviesRes = await fetch(`https://api.themoviedb.org/3/trending/movie/day?api_key=${tmdbApiKey}`);
                const trendingMoviesData = await trendingMoviesRes.json();
                renderNumberedMediaCards(trendingMoviesData.results.slice(0, 10), trendingMovies, 'movie');

                // Load popular TV shows
                const popularTvRes = await fetch(`https://api.themoviedb.org/3/tv/popular?api_key=${tmdbApiKey}`);
                const popularTvData = await popularTvRes.json();
                renderNumberedMediaCards(popularTvData.results.slice(0, 10), popularTv, 'tv');

                // Load trending anime from AniList
                const topAnime = await fetchTopAnime(10);
                if (topAnime) {
                    renderNumberedMediaCards(topAnime, trendingAnime, 'anime');
                } else {
                    // Fallback to TMDB if AniList fails
                    const animeRes = await fetch(`https://api.themoviedb.org/3/discover/tv?api_key=${tmdbApiKey}&with_genres=16`);
                    const animeData = await animeRes.json();
                    renderNumberedMediaCards(animeData.results.slice(0, 10), trendingAnime, 'tv');
                }

                // Set hero content to first trending movie
                if (trendingMoviesData.results.length > 0) {
                    const heroMedia = trendingMoviesData.results[0];
                    heroTitle.textContent = heroMedia.title;
                    heroDescription.textContent = heroMedia.overview || 'No description available';
                    heroImage.src = heroMedia.backdrop_path 
                        ? `https://image.tmdb.org/t/p/original${heroMedia.backdrop_path}`
                        : 'https://placehold.co/1920x1080';
                    heroImage.alt = `${heroMedia.title} backdrop`;

                    // Add event listeners to hero buttons
                    const heroWatchBtn = heroImage.closest('.relative').querySelector('button:first-child');
                    const heroWatchlistBtn = heroImage.closest('.relative').querySelector('button:last-child');

                    heroWatchBtn.onclick = () => playMedia(heroMedia.id, 'movie');
                    heroWatchlistBtn.onclick = () => toggleWatchlist(heroMedia.id, 'movie');
                }
            } catch (error) {
                console.error('Error loading featured content:', error);
            }
        }

        async function loadTopMovies() {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/top_rated?api_key=${tmdbApiKey}`);
                const data = await response.json();
                renderNumberedMediaCards(data.results.slice(0, 10), document.getElementById('movies').querySelector('div'), 'movie');
            } catch (error) {
                console.error('Error loading top movies:', error);
            }
        }

        async function loadTopTVShows() {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/tv/top_rated?api_key=${tmdbApiKey}`);
                const data = await response.json();
                renderNumberedMediaCards(data.results.slice(0, 10), document.getElementById('tv').querySelector('div'), 'tv');
            } catch (error) {
                console.error('Error loading top TV shows:', error);
            }
        }

        async function loadTopAnime() {
            try {
                const topAnime = await fetchTopAnime(10);
                if (topAnime) {
                    renderNumberedMediaCards(topAnime, document.getElementById('anime').querySelector('div'), 'anime');
                } else {
                    // Fallback to TMDB if AniList fails
                    const response = await fetch(`https://api.themoviedb.org/3/discover/tv?api_key=${tmdbApiKey}&with_genres=16`);
                    const data = await response.json();
                    renderNumberedMediaCards(data.results.slice(0, 10), document.getElementById('anime').querySelector('div'), 'tv');
                }
            } catch (error) {
                console.error('Error loading top anime:', error);
            }
        }

        async function fetchTopAnime(limit = 10) {
            try {
                const query = `
                    query {
                        Page(perPage: ${limit}) {
                            media(sort: POPULARITY_DESC, type: ANIME) {
                                id
                                title {
                                    romaji
                                    english
                                    native
                                }
                                coverImage {
                                    large
                                }
                                averageScore
                                startDate {
                                    year
                                }
                            }
                        }
                    }
                `;

                const response = await fetch(anilistEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query
                    })
                });

                const result = await response.json();
                if (result.data && result.data.Page.media) {
                    return result.data.Page.media.map(anime => ({
                        id: anime.id,
                        title: anime.title.english || anime.title.romaji || anime.title.native,
                        poster_path: anime.coverImage?.large || null,
                        vote_average: anime.averageScore ? anime.averageScore / 10 : null,
                        release_date: anime.startDate?.year ? String(anime.startDate.year) : null
                    }));
                }
                return null;
            } catch (error) {
                console.error('Error fetching from AniList:', error);
                return null;
            }
        }

        function renderNumberedMediaCards(items, container, type) {
            container.innerHTML = '';

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">No results found</div>';
                return;
            }

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'relative group cursor-pointer card-hover';

                // Determine title and poster path based on media type
                const title = item.title;
                const posterPath = item.poster_path || 'https://placehold.co/500x750';

                card.innerHTML = `
                    <div class="top-number">${index + 1}</div>
                    <img src="${posterPath}" alt="${title}" 
                        class="w-full h-full object-cover rounded-lg transition duration-300 group-hover:opacity-70 relative z-0" 
                        onerror="this.src='https://placehold.co/500x750?text=No+Poster'">
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent rounded-b-lg z-10">
                        <h3 class="font-semibold truncate">${title}</h3>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm text-gray-300">
                                ${item.vote_average ? item.vote_average.toFixed(1) + ' ★' : 'N/A'}
                            </span>
                            <span class="text-xs text-gray-300">
                                ${item.release_date ? item.release_date.substring(0, 4) : 'N/A'}
                            </span>
                        </div>
                    </div>
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <button class="bg-accent px-4 py-2 rounded-full hover:bg-blue-700 transition">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                `;

                // Add click event to play media
                card.addEventListener('click', () => {
                    if (type === 'anime') {
                        playAnime(item.id, 1); // Default to episode 1 for anime
                    } else {
                        playMedia(item.id, type);
                    }
                });

                container.appendChild(card);
            });
        }

        async function searchContent(query) {
            try {
                searchResultsContent.innerHTML = '';

                // Search movies
                const moviesRes = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${tmdbApiKey}&query=${query}`);
                const moviesData = await moviesRes.json();

                // Filter and map results
                const combinedResults = moviesData.results
                    .filter(item => item.media_type === 'movie' || item.media_type === 'tv')
                    .map(item => ({
                        ...item,
                        title: item.title || item.name,
                        release_date: item.release_date || item.first_air_date
                    }));

                if (combinedResults.length === 0) {
                    searchResultsContent.innerHTML = '<div class="text-center py-10 text-gray-500">No results found</div>';
                    return;
                }

                // Render results with numbering
                combinedResults.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'relative group cursor-pointer card-hover';

                    const posterPath = item.poster_path 
                        ? `https://image.tmdb.org/t/p/w500${item.poster_path}`
                        : 'https://placehold.co/500x750';

                    card.innerHTML = `
                        <div class="top-number">${index + 1}</div>
                        <img src="${posterPath}" alt="${item.title}" 
                            class="w-full h-full object-cover rounded-lg transition duration-300 group-hover:opacity-70 relative z-0" 
                            onerror="this.src='https://placehold.co/500x750?text=No+Poster'">
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent rounded-b-lg z-10">
                            <h3 class="font-semibold truncate">${item.title}</h3>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-sm text-gray-300 capitalize">${item.media_type}</span>
                                <span class="text-xs text-gray-300">
                                    ${item.release_date ? item.release_date.substring(0, 4) : 'N/A'}
                                </span>
                            </div>
                        </div>
                    `;

                    card.addEventListener('click', () => {
                        if (item.media_type === 'movie') {
                            playMedia(item.id, 'movie');
                        } else if (item.media_type === 'tv') {
                            openDetailsModal(item.id, 'tv');
                        }
                    });

                    searchResultsContent.appendChild(card);
                });
            } catch (error) {
                console.error('Error searching content:', error);
            }
        }

        async function playMedia(mediaId, mediaType) {
            try {
                let embedUrl = '';
                
                if (mediaType === 'movie') {
                    embedUrl = `https://vidsrc.cc/v2/embed/movie/${mediaId}?autoPlay=false`;
                } else if (mediaType === 'tv') {
                    embedUrl = `https://vidsrc.cc/v2/embed/tv/${mediaId}?autoPlay=false`;
                }
                
                if (embedUrl) {
                    playerModal.classList.remove('hidden');
                    playerFrame.src = embedUrl;
                    playerTitle.textContent = `Now Playing: ${mediaType === 'movie' ? 'Movie' : 'TV Show'}`;
                    
                    // Hide episode controls for movies
                    document.getElementById('episodeControls').classList.add('hidden');
                } else {
                    throw new Error('Invalid media type');
                }
            } catch (error) {
                console.error('Error playing media:', error);
                alert('Failed to play media');
            }
        }

        async function playAnime(animeId, episodeNumber) {
            try {
                const embedUrl = `https://vidsrc.cc/v2/embed/anime/ani${animeId}/${episodeNumber}/sub?autoPlay=false`;
                
                playerModal.classList.remove('hidden');
                playerFrame.src = embedUrl;
                playerTitle.textContent = 'Now Playing: Anime';
                
                // Show episode controls for anime
                const controls = document.getElementById('episodeControls');
                controls.classList.remove('hidden');
                
                // Set current episode info
                currentEpisodeTitle.textContent = `Episode ${episodeNumber}`;
                currentEpisodeDescription.textContent = 'Anime episode';
                
                // Track watch progress if logged in
                if (currentUser) {
                    updateWatchProgress(animeId, 1, episodeNumber, 'anime');
                }
            } catch (error) {
                console.error('Error playing anime:', error);
                alert('Failed to play anime');
            }
        }

        async function playTVEpisode(tvId, seasonNumber, episodeNumber) {
            try {
                const embedUrl = `https://vidsrc.cc/v2/embed/tv/${tvId}/${seasonNumber}/${episodeNumber}?autoPlay=false`;
                
                playerModal.classList.remove('hidden');
                playerFrame.src = embedUrl;
                playerTitle.textContent = 'Now Playing: Episode';
                
                // Show episode controls
                const controls = document.getElementById('episodeControls');
                controls.classList.remove('hidden');
                
                // Set current episode info
                const episode = currentEpisodes.find(e => e.episode_number === episodeNumber);
                if (episode) {
                    currentEpisodeTitle.textContent = `S${seasonNumber}E${episodeNumber}: ${episode.name}`;
                    currentEpisodeDescription.textContent = episode.overview || 'No description available';
                    
                    // Set current episode index for navigation
                    const episodeIndex = currentEpisodes.findIndex(e => e.episode_number === episodeNumber);
                    playerFrame.setAttribute('data-episode-index', episodeIndex);
                }
                
                // Update watch progress if logged in
                if (currentUser) {
                    updateWatchProgress(tvId, seasonNumber, episodeNumber, 'tv');
                }
            } catch (error) {
                console.error('Error playing episode:', error);
                alert('Failed to play episode');
            }
        }

        function playEpisode(episodeIndex) {
            if (episodeIndex >= 0 && episodeIndex < currentEpisodes.length) {
                const episode = currentEpisodes[episodeIndex];
                if (currentMediaType === 'tv') {
                    playTVEpisode(currentMediaId, currentSeason, episode.episode_number);
                } else if (currentMediaType === 'anime') {
                    playAnime(currentMediaId, episode.episode_number);
                }
            }
        }

        async function updateWatchProgress(mediaId, seasonNumber, episodeNumber, mediaType) {
            if (!currentUser) return;
            
            try {
                await supabase
                    .from('watch_progress')
                    .upsert({
                        user_id: currentUser.id,
                        media_id: mediaId,
                        media_type: mediaType,
                        season_number: seasonNumber || 1,
                        episode_number: episodeNumber || 1,
                        last_watched_at: new Date()
                    }, { onConflict: ['user_id', 'media_id'] });
            } catch (error) {
                console.error('Error updating watch progress:', error);
            }
        }

        async function openDetailsModal(mediaId, mediaType) {
            currentMediaType = mediaType;
            currentMediaId = mediaId;

            try {
                let details;
                if (mediaType === 'tv') {
                    const response = await fetch(`https://api.themoviedb.org/3/tv/${mediaId}?api_key=${tmdbApiKey}`);
                    details = await response.json();
                    populateTVDetails(details);
                } else if (mediaType === 'movie') {
                    const response = await fetch(`https://api.themoviedb.org/3/movie/${mediaId}?api_key=${tmdbApiKey}`);
                    details = await response.json();
                    populateMovieDetails(details);
                } else if (mediaType === 'anime') {
                    const anime = await getAnimeDetails(mediaId);
                    if (anime) {
                        populateAnimeDetails(anime);
                    } else {
                        throw new Error('Failed to load anime details');
                    }
                }

                // Check watchlist status
                if (currentUser) {
                    checkWatchlistStatus(mediaId, mediaType);
                }

                detailsModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading details:', error);
                alert('Failed to load media details');
            }
        }

        async function getAnimeDetails(animeId) {
            try {
                const query = `
                    query ($id: Int) {
                        Media(id: $id, type: ANIME) {
                            id
                            title {
                                romaji
                                english
                                native
                            }
                            description
                            coverImage {
                                large
                                extraLarge
                            }
                            bannerImage
                            averageScore
                            status
                            startDate {
                                year
                                month
                                day
                            }
                            episodes
                        }
                    }
                `;

                const response = await fetch(anilistEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: { id: animeId }
                    })
                });

                const result = await response.json();
                if (result.data && result.data.Media) {
                    return result.data.Media;
                }
                return null;
            } catch (error) {
                console.error('Error fetching anime details:', error);
                return null;
            }
        }

        function populateMovieDetails(movie) {
            detailsTitle.textContent = movie.title;
            detailsBackdrop.src = movie.backdrop_path 
                ? `https://image.tmdb.org/t/p/original${movie.backdrop_path}`
                : 'https://placehold.co/1280x720';
            detailsPoster.src = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                : 'https://placehold.co/500x750';
            detailsOverview.textContent = movie.overview || 'No overview available';
            detailsStatus.textContent = movie.status || 'N/A';
            detailsDate.textContent = movie.release_date || 'N/A';
            detailsRating.textContent = movie.vote_average ? movie.vote_average.toFixed(1) + '/10' : 'N/A';

            // Handle genres
            detailsGenres.innerHTML = '';
            if (movie.genres && movie.genres.length > 0) {
                movie.genres.forEach(genre => {
                    const genreEl = document.createElement('span');
                    genreEl.className = 'bg-accent px-3 py-1 text-sm rounded-full';
                    genreEl.textContent = genre.name;
                    detailsGenres.appendChild(genreEl);
                });
            }

            // Hide seasons/episodes for movies
            seasonsContainer.classList.add('hidden');
            episodesContainer.classList.add('hidden');

            // Set watch now button action
            watchNowBtn.onclick = () => playMedia(movie.id, 'movie');
        }

        function populateTVDetails(tvShow) {
            detailsTitle.textContent = tvShow.name;
            detailsBackdrop.src = tvShow.backdrop_path 
                ? `https://image.tmdb.org/t/p/original${tvShow.backdrop_path}`
                : 'https://placehold.co/1280x720';
            detailsPoster.src = tvShow.poster_path 
                ? `https://image.tmdb.org/t/p/w500${tvShow.poster_path}`
                : 'https://placehold.co/500x750';
            detailsOverview.textContent = tvShow.overview || 'No overview available';
            detailsStatus.textContent = tvShow.status || 'N/A';
            detailsDate.textContent = tvShow.first_air_date || 'N/A';
            detailsRating.textContent = tvShow.vote_average ? tvShow.vote_average.toFixed(1) + '/10' : 'N/A';

            // Handle genres
            detailsGenres.innerHTML = '';
            if (tvShow.genres && tvShow.genres.length > 0) {
                tvShow.genres.forEach(genre => {
                    const genreEl = document.createElement('span');
                    genreEl.className = 'bg-accent px-3 py-1 text-sm rounded-full';
                    genreEl.textContent = genre.name;
                    detailsGenres.appendChild(genreEl);
                });
            }

            // Show seasons and episodes for TV shows
            seasonsContainer.classList.remove('hidden');
            episodesContainer.classList.remove('hidden');
            
            // Load seasons
            seasonsData = tvShow.seasons;
            renderSeasons(seasonsData);

            // Load first season episodes by default
            if (tvShow.seasons.length > 0) {
                loadEpisodes(tvShow.id, 1);
            }

            // Set watch now button action
            watchNowBtn.onclick = () => {
                if (tvShow.seasons.length > 0 && tvShow.seasons[0].season_number > 0) {
                    playTVEpisode(tvShow.id, 1, 1);
                }
            };
        }

        function populateAnimeDetails(anime) {
            detailsTitle.textContent = anime.title?.english || anime.title?.romaji || anime.title?.native || 'Anime';
            
            detailsBackdrop.src = anime.bannerImage 
                ? anime.bannerImage 
                : 'https://placehold.co/1280x720';
                
            detailsPoster.src = anime.coverImage?.extraLarge || anime.coverImage?.large || 'https://placehold.co/500x750';
            
            // Clean up description (AniList descriptions include HTML tags)
            const cleanDescription = anime.description 
                ? anime.description.replace(/<\/?[^>]+(>|$)/g, '') 
                : 'No description available';
            detailsOverview.textContent = cleanDescription.length > 300 
                ? cleanDescription.substring(0, 300) + '...' 
                : cleanDescription;
                
            detailsStatus.textContent = anime.status ? anime.status.replace(/_/g, ' ') : 'N/A';
            detailsDate.textContent = anime.startDate?.year ? anime.startDate.year : 'N/A';
            detailsRating.textContent = anime.averageScore ? (anime.averageScore / 10).toFixed(1) + '/10' : 'N/A';

            // Handle genres (not available in this basic implementation)
            detailsGenres.innerHTML = '<span class="bg-accent px-3 py-1 text-sm rounded-full">Anime</span>';

            // For anime, we'll show episode list in the episodes container
            seasonsContainer.classList.add('hidden');
            episodesContainer.classList.remove('hidden');
            
            // Create a simple episode list for anime (1 to total episodes)
            if (anime.episodes) {
                currentEpisodes = Array.from({length: anime.episodes}, (_, i) => ({
                    episode_number: i + 1,
                    name: `Episode ${i + 1}`,
                    overview: ''
                }));
                renderEpisodes(currentEpisodes);
            }

            // Set watch now button action
            watchNowBtn.onclick = () => playAnime(anime.id, 1);
        }

        function renderSeasons(seasons) {
            seasonsList.innerHTML = '';
            seasons.forEach(season => {
                if (season.season_number === 0) return; // Skip special seasons

                const seasonEl = document.createElement('div');
                seasonEl.className = 'flex flex-col items-center cursor-pointer';
                seasonEl.innerHTML = `
                    <div class="relative w-full aspect-[2/3] rounded-lg overflow-hidden">
                        <img src="${season.poster_path 
                            ? `https://image.tmdb.org/t/p/w185${season.poster_path}`
                            : 'https://placehold.co/185x278'}" 
                            alt="${season.name}" class="w-full h-full object-cover"
                            onerror="this.src='https://placehold.co/185x278?text=No+Poster'">
                    </div>
                    <h4 class="mt-2 text-center font-medium truncate w-full">${season.name}</h4>
                    <p class="text-xs text-gray-400">${season.episode_count} episodes</p>
                `;

                seasonEl.addEventListener('click', () => {
                    currentSeason = season.season_number;
                    loadEpisodes(currentMediaId, season.season_number);
                });

                seasonsList.appendChild(seasonEl);
            });
        }

        async function loadEpisodes(tvId, seasonNumber) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${tmdbApiKey}`);
                const data = await response.json();
                currentEpisodes = data.episodes;
                renderEpisodes(data.episodes);
            } catch (error) {
                console.error('Error loading episodes:', error);
                episodesList.innerHTML = '<p class="text-gray-400">Failed to load episodes</p>';
            }
        }

        function renderEpisodes(episodes) {
            episodesList.innerHTML = '';
            
            if (!episodes || episodes.length === 0) {
                episodesList.innerHTML = '<p class="text-gray-400">No episodes available</p>';
                return;
            }

            episodes.forEach((episode, index) => {
                const episodeEl = document.createElement('div');
                episodeEl.className = 'bg-gray-800 rounded-lg p-4 flex gap-4 cursor-pointer hover:bg-gray-700 transition';
                episodeEl.innerHTML = `
                    <div class="flex-shrink-0 w-32 h-20 bg-gray-700 rounded overflow-hidden">
                        <img src="${episode.still_path 
                            ? `https://image.tmdb.org/t/p/w300${episode.still_path}`
                            : 'https://placehold.co/300x169'}" 
                            alt="${episode.name}" class="w-full h-full object-cover"
                            onerror="this.src='https://placehold.co/300x169?text=No+Image'">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium flex items-center gap-2">
                            <span>Episode ${episode.episode_number}</span>
                            ${episode.vote_average ? 
                                `<span class="text-xs bg-primary px-2 py-1 rounded">${episode.vote_average.toFixed(1)}</span>` : ''}
                        </h4>
                        <h3 class="font-semibold">${episode.name || 'Untitled Episode'}</h3>
                        <p class="text-sm text-gray-400 line-clamp-2">${episode.overview || 'No description available'}</p>
                        <p class="text-xs text-gray-500 mt-1">${episode.air_date || 'Airdate unknown'}</p>
                    </div>
                `;

                episodeEl.addEventListener('click', () => {
                    if (currentMediaType === 'tv') {
                        playTVEpisode(currentMediaId, currentSeason, episode.episode_number);
                    } else if (currentMediaType === 'anime') {
                        playAnime(currentMediaId, episode.episode_number);
                    }
                });

                episodesList.appendChild(episodeEl);
            });
        }

        async function checkWatchlistStatus(mediaId, mediaType) {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('watchlist')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('media_id', mediaId)
                    .eq('media_type', mediaType)
                    .maybeSingle();

                if (!error) {
                    if (data) {
                        watchlistBtn.innerHTML = '<i class="fas fa-check mr-2"></i> In Watchlist';
                        watchlistBtn.classList.add('bg-green-600', 'border-green-600');
                        watchlistBtn.classList.remove('border-accent', 'hover:bg-blue-900');
                    } else {
                        watchlistBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add to Watchlist';
                        watchlistBtn.classList.remove('bg-green-600', 'border-green-600');
                        watchlistBtn.classList.add('border-accent', 'hover:bg-blue-900');
                    }
                }
            } catch (error) {
                console.error('Error checking watchlist status:', error);
            }
        }

        async function toggleWatchlist(mediaId, mediaType) {
            if (!currentUser) {
                authModal.classList.remove('hidden');
                return;
            }

            try {
                // Check if already in watchlist
                const { data: existing, error: checkError } = await supabase
                    .from('watchlist')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('media_id', mediaId)
                    .eq('media_type', mediaType)
                    .maybeSingle();

                if (checkError) throw checkError;

                if (existing) {
                    // Remove from watchlist
                    const { error: deleteError } = await supabase
                        .from('watchlist')
                        .delete()
                        .eq('id', existing.id);

                    if (deleteError) throw deleteError;

                    watchlistBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add to Watchlist';
                    watchlistBtn.classList.remove('bg-green-600', 'border-green-600');
                    watchlistBtn.classList.add('border-accent', 'hover:bg-blue-900');
                } else {
                    // Add to watchlist
                    let title, poster;
                    
                    if (mediaType === 'anime') {
                        const anime = await getAnimeDetails(mediaId);
                        title = anime.title?.english || anime.title?.romaji || anime.title?.native;
                        poster = anime.coverImage?.large || anime.coverImage?.extraLarge;
                    } else {
                        const details = await getMediaDetails(mediaId, mediaType);
                        title = mediaType === 'movie' ? details.title : details.name;
                        poster = details.poster_path ? `https://image.tmdb.org/t/p/w500${details.poster_path}` : null;
                    }

                    const { error: insertError } = await supabase
                        .from('watchlist')
                        .insert({
                            user_id: currentUser.id,
                            media_id: mediaId,
                            media_type: mediaType,
                            title,
                            poster_path: poster,
                            added_at: new Date()
                        });

                    if (insertError) throw insertError;

                    watchlistBtn.innerHTML = '<i class="fas fa-check mr-2"></i> In Watchlist';
                    watchlistBtn.classList.add('bg-green-600', 'border-green-600');
                    watchlistBtn.classList.remove('border-accent', 'hover:bg-blue-900');
                }

                // Update watchlist count
                updateWatchlistCount();
                
                // Refresh watchlist if on that page
                if (document.getElementById('watchlist') && !document.getElementById('watchlist').classList.contains('hidden')) {
                    loadWatchlist();
                }
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                alert('Failed to update watchlist');
            }
        }

        async function getMediaDetails(mediaId, mediaType) {
            const response = await fetch(`https://api.themoviedb.org/3/${mediaType}/${mediaId}?api_key=${tmdbApiKey}`);
            return await response.json();
        }

        async function loadWatchlist() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('watchlist')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('added_at', { ascending: false });

                if (error) throw error;

                watchlistContent.innerHTML = '';

                if (!data || data.length === 0) {
                    watchlistContent.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <i class="fas fa-bookmark text-5xl mb-2"></i>
                            <p>Your watchlist is empty</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'relative group cursor-pointer card-hover';

                    card.innerHTML = `
                        <img src="${item.poster_path || 'https://placehold.co/500x750'}" 
                            alt="${item.title}" 
                            class="w-full h-full object-cover rounded-lg transition duration-300 group-hover:opacity-70"
                            onerror="this.src='https://placehold.co/500x750?text=No+Poster'">
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent rounded-b-lg">
                            <h3 class="font-semibold truncate">${item.title}</h3>
                            <p class="text-xs text-gray-300 capitalize">${item.media_type}</p>
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <button class="bg-accent px-4 py-2 rounded-full hover:bg-blue-700 transition">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    `;

                    card.addEventListener('click', () => {
                        if (item.media_type === 'movie' || item.media_type === 'tv') {
                            openDetailsModal(item.media_id, item.media_type);
                        } else if (item.media_type === 'anime') {
                            playAnime(item.media_id, 1); // Default to episode 1 for anime
                        }
                    });

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = async (e) => {
                        e.stopPropagation();
                        await supabase
                            .from('watchlist')
                            .delete()
                            .eq('id', item.id);
                        loadWatchlist();
                        updateWatchlistCount();
                    };
                    card.appendChild(removeBtn);

                    watchlistContent.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        async function loadProfile() {
            if (!currentUser) return;

            profileUsername.textContent = currentUser.profile?.username || 'User';
            profileEmail.textContent = currentUser.email;
            profileAvatar.src = currentUser.profile?.avatar_url || 'https://placehold.co/120x120';
            accountCreated.textContent = new Date(currentUser.created_at).toLocaleDateString();

            // Get watch progress
            const { data: progress, error } = await supabase
                .from('watch_progress')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('last_watched_at', { ascending: false });

            if (!error && progress && progress.length > 0) {
                // Add "Continue Watching" section to profile
                const profileContainer = document.querySelector('#profile > div');
                
                // Remove existing continue watching section if present
                const existingContinueWatching = document.getElementById('continueWatchingContainer');
                if (existingContinueWatching) {
                    existingContinueWatching.remove();
                }

                const continueWatching = document.createElement('div');
                continueWatching.className = 'mt-8';
                continueWatching.id = 'continueWatchingContainer';
                continueWatching.innerHTML = `
                    <h2 class="text-xl font-bold mb-6">Continue Watching</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="continueWatching"></div>
                `;

                profileContainer.appendChild(continueWatching);

                // Process the first 5 items
                const itemsToShow = progress.slice(0, 5);
                
                for (const item of itemsToShow) {
                    try {
                        let title, poster, mediaType;
                        
                        if (item.media_type === 'anime') {
                            const anime = await getAnimeDetails(item.media_id);
                            if (!anime) continue;
                            
                            title = anime.title?.english || anime.title?.romaji || anime.title?.native;
                            poster = anime.coverImage?.large || anime.coverImage?.extraLarge;
                            mediaType = 'anime';
                        } else {
                            const details = await getMediaDetails(item.media_id, item.media_type);
                            title = item.media_type === 'movie' ? details.title : details.name;
                            poster = details.poster_path 
                                ? `https://image.tmdb.org/t/p/w300${details.poster_path}`
                                : 'https://placehold.co/300x450';
                            mediaType = item.media_type;
                        }

                        const card = document.createElement('div');
                        card.className = 'relative group cursor-pointer';
                        card.innerHTML = `
                            <img src="${poster}" alt="${title}" 
                                class="w-full rounded-lg"
                                onerror="this.src='https://placehold.co/300x450?text=No+Poster'">
                            <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent rounded-b-lg">
                                <p class="text-sm truncate">${title}</p>
                                ${item.media_type === 'tv' || item.media_type === 'anime'
                                    ? `<p class="text-xs text-gray-300">E${item.episode_number}</p>`
                                    : ''}
                            </div>
                        `;

                        card.addEventListener('click', () => {
                            if (item.media_type === 'tv') {
                                playTVEpisode(item.media_id, item.season_number, item.episode_number);
                            } else if (item.media_type === 'anime') {
                                playAnime(item.media_id, item.episode_number);
                            } else {
                                playMedia(item.media_id, 'movie');
                            }
                        });

                        document.getElementById('continueWatching').appendChild(card);
                    } catch (error) {
                        console.error('Error loading continue watching item:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
